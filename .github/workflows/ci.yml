name: CI

on:
  push:
    branches: [ci-upgrade, main, master]
  pull_request:
    branches: [ci-upgrade, main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      CI: true

    steps:
      # --------------------------------------------------------
      # 1. Checkout repository
      # --------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2. Set up Node.js environment
      # --------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      # --------------------------------------------------------
      # 3. Install dependencies with retries (handles ECONNRESET)
      # --------------------------------------------------------
      - name: Install dependencies (with retries)
        run: |
          echo "🚀 Installing dependencies..."
          for i in 1 2 3; do
            npm ci && break || echo "⚠️ npm ci failed on attempt $i, retrying in 5s..."
            sleep 5
          done
          if [ $? -ne 0 ]; then
            echo "⚠️ npm ci failed after 3 attempts — falling back to npm install"
            npm install
          fi

      # --------------------------------------------------------
      # 4. Validate PostCSS config (support .cjs or .js)
      # --------------------------------------------------------
      - name: Validate PostCSS config
        run: |
          if [ -f "apps/dashboard-charts/apps/web/postcss.config.cjs" ]; then
            POSTCSS_FILE="apps/dashboard-charts/apps/web/postcss.config.cjs"
          elif [ -f "apps/dashboard-charts/apps/web/postcss.config.js" ]; then
            POSTCSS_FILE="apps/dashboard-charts/apps/web/postcss.config.js"
          else
            echo "❌ No PostCSS config file found"
            exit 1
          fi

          if grep -q "@tailwindcss/postcss" "$POSTCSS_FILE"; then
            echo "✅ PostCSS config ($POSTCSS_FILE) is correct"
          else
            echo "❌ PostCSS config missing @tailwindcss/postcss"
            exit 1
          fi

      # --------------------------------------------------------
      # 5. Clean previous build artifacts
      # --------------------------------------------------------
      - name: Clean old builds
        run: rm -rf apps/dashboard-charts/apps/web/.next

      # --------------------------------------------------------
      # 6. Build, Lint, and Type-Check
      # --------------------------------------------------------
      - name: Build / Lint / Type-Check
        run: npm run ci:web

      # --------------------------------------------------------
      # 7. CI Summary
      # --------------------------------------------------------
      - name: CI Summary
        if: always()
        run: |
          echo "### ✅ CI Summary (Auto)" >> $GITHUB_STEP_SUMMARY
          echo "Build completed at $(date)" >> $GITHUB_STEP_SUMMARY

